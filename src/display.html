<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Turbidez da √Ågua - Swipe</title>
  <style>
    body {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      overflow: hidden;
    }

    .carousel-container {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    .carousel-wrapper {
      display: flex;
      height: 100%;
      transition: transform 0.4s ease;
      -webkit-transition: -webkit-transform 0.4s ease;
      will-change: transform;

      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }

    .card {
      flex: 0 0 100vw;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 2rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      margin: 0 10px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .turbidez {
      font-size: 3rem;
      margin-top: 10px;
      font-weight: bold;
      padding: 15px 25px;
      border-radius: 12px;
    }

    .safe {
      background: #2ecc71;
      color: #fff;
    }

    .medium {
      background: #f1c40f;
      color: #fff;
    }

    .danger {
      background: #e74c3c;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="carousel-container">
    <div class="carousel-wrapper" id="carouselWrapper"></div>
  </div>

  <script>
    const API_TURBIDEZ = "https://caravana-ciencia.onrender.com/api/historico_turbidez.php";

    const carouselWrapper = document.getElementById("carouselWrapper");
    const cards = [];
    const ultimoValor = [];

    let currentIndex = 0;

    // helper para aplicar transform com fallback webkit
    function setTranslateX(index) {
      const slideWidth = window.innerWidth; // largura real da viewport
      const value = `translateX(-${index * slideWidth}px)`;
      carouselWrapper.style.transform = value;
      carouselWrapper.style.webkitTransform = value;
    }

    async function inicializarCards() {
      for (let idPraia = 1; idPraia <= 3; idPraia++) {
        try {
          const resp = await fetch(API_TURBIDEZ, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id_praia: idPraia })
          });
          const dados = await resp.json();
          const turbidezAtual = dados.turbidez_atual?.[0];
          const praiaNome = turbidezAtual?.praia_nome || `Praia ${idPraia}`;
          const valor = turbidezAtual?.turbidez_atual || "--";

          const card = document.createElement("div");
          card.classList.add("card");
          card.dataset.praia = idPraia;

          let classeCor = "";
          const numValor = parseFloat(valor.replace(",", "."));
          if (!isNaN(numValor)) {
            if (numValor < 30) classeCor = "safe";
            else if (numValor < 70) classeCor = "medium";
            else classeCor = "danger";
          }

          card.innerHTML = `<h2>${praiaNome}</h2><div class="turbidez ${classeCor}">${valor}</div>`;
          carouselWrapper.appendChild(card);

          cards.push(card);
          ultimoValor.push(valor);
        } catch (e) {
          console.error("Erro ao criar card:", e);
        }
      }
    }

    async function atualizarCardVisivel() {
      const cardVisivel = cards[currentIndex];
      if (!cardVisivel) return;

      const idPraia = cardVisivel.dataset.praia;
      try {
        const resp = await fetch(API_TURBIDEZ, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id_praia: idPraia })
        });
        const dados = await resp.json();
        const turbidezAtual = dados.turbidez_atual?.[0];
        const valor = turbidezAtual?.turbidez_atual || "--";

        if (valor !== ultimoValor[currentIndex]) {
          let classeCor = "";
          const numValor = parseFloat(valor.replace(",", "."));
          if (!isNaN(numValor)) {
            if (numValor < 30) classeCor = "safe";
            else if (numValor < 70) classeCor = "medium";
            else classeCor = "danger";
          }
          cardVisivel.querySelector(".turbidez").className = `turbidez ${classeCor}`;
          cardVisivel.querySelector(".turbidez").textContent = valor;
          ultimoValor[currentIndex] = valor;
        }
      } catch (e) {
        console.error("Erro ao atualizar card:", e);
      }
    }

    // Swipe
    let startX = 0;
    carouselWrapper.addEventListener("touchstart", (e) => {
      startX = e.touches[0].clientX;
    });

    carouselWrapper.addEventListener("touchend", (e) => {
      const deltaX = e.changedTouches[0].clientX - startX;
      const threshold = 50;
      const maxIndex = cards.length - 1;

      if (deltaX < -threshold && currentIndex < maxIndex) {
        currentIndex++;
      } else if (deltaX > threshold && currentIndex > 0) {
        currentIndex--;
      }

      setTranslateX(currentIndex);
    });

    inicializarCards().then(() => {
      setTranslateX(0);
      setInterval(atualizarCardVisivel, 5000);
    });
  </script>
</body>
</html>
